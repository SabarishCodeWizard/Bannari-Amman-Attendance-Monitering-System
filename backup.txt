from flask import Flask, request, render_template, redirect, url_for, flash, session
import os
import cv2
import numpy as np
from datetime import date, datetime
import joblib
from sklearn.neighbors import KNeighborsClassifier
from gtts import gTTS
from io import BytesIO
import pygame
import smtplib
from email.mime.text import MIMEText
from cryptography.fernet import Fernet
import logging
from pymongo import MongoClient
import base64

#### Defining Flask App
app = Flask(__name__)
app.secret_key = os.urandom(24)

#### Logging Setup
logging.basicConfig(filename='app.log', level=logging.INFO)

#### Initialize encryption (optional)
key = Fernet.generate_key()
cipher_suite = Fernet(key)

#### MongoDB Setup
client = MongoClient('mongodb://localhost:27017/')
db = client.attendance_db
users_collection = db.users
attendance_collection = db.attendance

#### Saving Date today in 2 different formats
datetoday = date.today().strftime("%m_%d_%y")
datetoday2 = date.today().strftime("%d-%B-%Y")

#### Initializing VideoCapture object to access WebCam
face_detector = cv2.CascadeClassifier('haarcascade_frontalface_default.xml')

#### Utility Functions
def totalreg():
    return users_collection.count_documents({})

def extract_faces(img):
    try:
        if img.shape != (0, 0, 0):
            gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
            face_points = face_detector.detectMultiScale(gray, 1.3, 5)
            return face_points
        else:
            return []
    except Exception as e:
        logging.error(f"Error in extract_faces: {e}")
        return []

def identify_face(facearray):
    model = joblib.load('static/face_recognition_model.pkl')
    return model.predict(facearray)

def train_model():
    faces = []
    labels = []
    userlist = users_collection.find()
    for user in userlist:
        for face_data in user['faces']:
            img_data = base64.b64decode(face_data)
            img_array = np.frombuffer(img_data, np.uint8)
            img = cv2.imdecode(img_array, cv2.IMREAD_COLOR)
            resized_face = cv2.resize(img, (50, 50))
            faces.append(resized_face.ravel())
            labels.append(f"{user['name']}_{user['id']}")
    faces = np.array(faces)
    knn = KNeighborsClassifier(n_neighbors=5)
    knn.fit(faces, labels)
    joblib.dump(knn, 'static/face_recognition_model.pkl')

def extract_attendance():
    attendance_records = attendance_collection.find({"date": datetoday})
    names, rolls, times = [], [], []
    for record in attendance_records:
        names.append(record['name'])
        rolls.append(record['roll'])
        times.append(record['time'])
    l = len(names)
    return names, rolls, times, l

def add_attendance(name):
    username, userid = name.split('_')
    current_time = datetime.now().strftime("%H:%M:%S")
    
    if not attendance_collection.find_one({"roll": int(userid), "date": datetoday}):
        attendance_collection.insert_one({"name": username, "roll": int(userid), "time": current_time, "date": datetoday})
        return True
    return False

def play_voice_message(message):
    tts = gTTS(text=message, lang='en')
    fp = BytesIO()
    tts.write_to_fp(fp)
    fp.seek(0)

    pygame.mixer.init()
    pygame.mixer.music.load(fp)
    pygame.mixer.music.play()
    while pygame.mixer.music.get_busy():
        pygame.time.Clock().tick(10)

def send_email(subject, body, to_email):
    try:
        msg = MIMEText(body)
        msg['Subject'] = subject
        msg['From'] = 'sabarish.it22@bitsathy.ac.in'
        msg['To'] = to_email

        with smtplib.SMTP('smtp.example.com', 587) as server:  # Update SMTP settings
            server.starttls()
            server.login('your_email@example.com', 'your_password')  # Update this
            server.send_message(msg)
    except Exception as e:
        logging.error(f"Error in sending email: {e}")

def getallusers():
    userlist = users_collection.find()
    names, rolls = [], []
    for user in userlist:
        names.append(user['name'])
        rolls.append(user['id'])
    l = len(names)
    return userlist, names, rolls, l

#### Route Functions
@app.route('/')
def home():
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    
    names, rolls, times, l = extract_attendance()    
    return render_template('home.html', names=names, rolls=rolls, times=times, l=l, totalreg=totalreg(), datetoday2=datetoday2)  

@app.route('/start', methods=['GET'])
def start():
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    
    if 'face_recognition_model.pkl' not in os.listdir('static'):
        return render_template('home.html', totalreg=totalreg(), datetoday2=datetoday2, mess='There is no trained model in the static folder. Please add a new face to continue.')

    ret = True
    cap = cv2.VideoCapture(0)
    while ret:
        ret, frame = cap.read()
        if len(extract_faces(frame)) > 0:
            (x, y, w, h) = extract_faces(frame)[0]
            cv2.rectangle(frame, (x, y), (x+w, y+h), (255, 0, 20), 2)
            face = cv2.resize(frame[y:y+h, x:x+w], (50, 50))
            identified_person = identify_face(face.reshape(1, -1))[0]
            if add_attendance(identified_person):
                play_voice_message('Attendance marked successfully.')
                send_email('Attendance Update', f'User {identified_person} marked present at {datetime.now()}', 'recipient@example.com')
            cv2.putText(frame, f'{identified_person}', (30, 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 20), 2, cv2.LINE_AA)
        cv2.imshow('Attendance', frame)
        if cv2.waitKey(1) == 27:
            break
    cap.release()
    cv2.destroyAllWindows()
    names, rolls, times, l = extract_attendance()    
    return render_template('home.html', names=names, rolls=rolls, times=times, l=l, totalreg=totalreg(), datetoday2=datetoday2) 

@app.route('/add', methods=['GET', 'POST'])
def add():
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    
    if request.method == 'POST':
        newusername = request.form['newusername']
        newuserid = request.form['newuserid']
        user_faces = []
        i, j = 0, 0
        cap = cv2.VideoCapture(0)
        while 1:
            _, frame = cap.read()
            faces = extract_faces(frame)
            for (x, y, w, h) in faces:
                cv2.rectangle(frame, (x, y), (x+w, y+h), (255, 0, 0), 2)
                if j % 10 == 0:
                    face = frame[y:y+h, x:x+w]
                    resized_face = cv2.resize(face, (50, 50))
                    encoded_face = base64.b64encode(cv2.imencode('.jpg', resized_face)[1]).decode()
                    user_faces.append(encoded_face)
                    i += 1
                j += 1
            cv2.imshow('Adding new User', frame)
            if cv2.waitKey(1) == 27 or i == 20:
                break
        cap.release()
        cv2.destroyAllWindows()
        users_collection.insert_one({"name": newusername, "id": int(newuserid), "faces": user_faces})
        
        logging.info('Adding User and Training Model')
        train_model()
        return redirect(url_for('home'))
    return render_template('add.html')

@app.route('/edit_user/<username>', methods=['GET', 'POST'])
def edit_user(username):
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    
    if request.method == 'POST':
        new_username = request.form['new_username']
        new_userid = request.form['new_userid']
        
        users_collection.update_one({'name': username}, {'$set': {'name': new_username, 'id': int(new_userid)}})
        
        logging.info('Updating User and Training Model')
        train_model()
        
        return redirect(url_for('home'))
    
    user = users_collection.find_one({'name': username.split('_')[0], 'id': int(username.split('_')[1])})
    if not user:
        return 'User not found!', 404
    
    return render_template('edit_user.html', user=user)

@app.route('/delete_user/<username>', methods=['POST'])
def delete_user(username):
    if 'logged_in' not in session:
        return redirect(url_for('login'))
    
    users_collection.delete_one({'name': username.split('_')[0], 'id': int(username.split('_')[1])})
    logging.info('Deleting User and Training Model')
    train_model()
    return redirect(url_for('home'))

@app.route('/set_session', methods=['POST'])
def set_session():
    data = request.get_json()
    username = data.get('username')
    if username:
        session['logged_in'] = True
        session['username'] = username
        return {'status': 'success'}, 200
    return {'status': 'failed'}, 400


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        if username == 'bitsathy' and password == '1234':
            session['logged_in'] = True
            return redirect(url_for('home'))
        else:
            flash('Invalid username or password')
            return redirect(url_for('login'))
    return render_template('login.html')    

@app.route('/logout')
def logout():
    session.pop('logged_in', None)
    return redirect(url_for('login'))

if __name__ == '__main__':
    app.run(debug=True)


<!doctype html>
<html lang="en">

<style type='text/css'>
    * {
        padding: 0;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        box-sizing: border-box;
    }

    body {
        background-image: url("{{ url_for('static', filename='background.jpg') }}");
        background-size: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        padding: 20px;
    }

    .login-container {
        background-color: rgba(255, 255, 255, 0.9);
        padding: 30px;
        border-radius: 10px;
        width: 100%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
        font-size: 28px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .form-group input {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .btn {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        background-color: #343a40;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn:hover {
        background-color: #c9370e;
    }

    #google-login-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        color: #757575;
        font-size: 16px;
        padding: 12px;
        cursor: pointer;
        transition: box-shadow 0.3s, background-color 0.3s;
        margin-top: 20px;
    }

    #google-login-btn img {
        height: 20px;
        margin-right: 10px;
    }

    #google-login-btn:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background-color: #f5f5f5;
    }

    @media (max-width: 576px) {
        h1 {
            font-size: 24px;
        }

        .form-group label {
            font-size: 14px;
        }

        .form-group input {
            font-size: 14px;
            padding: 8px;
        }

        .btn {
            font-size: 16px;
            padding: 10px;
        }

        #google-login-btn {
            font-size: 14px;
            padding: 10px;
        }
    }
</style>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <title>Login</title>
</head>

<body>

    <div class="login-container">
        <h1>Login</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form action="" method="POST">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="btn">Login</button>
        </form>

        <div id="google-login-btn">
            <img src="https://www.google.com/imgres?q=google%20image&imgurl=https%3A%2F%2Flookaside.fbsbx.com%2Flookaside%2Fcrawler%2Fmedia%2F%3Fmedia_id%3D100044408950171&imgrefurl=https%3A%2F%2Fwww.facebook.com%2FGoogleIndia%2F&docid=_Qj6mz-Y48rawM&tbnid=xRberq3Fn2MoHM&vet=12ahUKEwj4hb_pvaSIAxXr2TgGHeoJLwsQM3oECBkQAA..i&w=2048&h=2048&hcb=2&ved=2ahUKEwj4hb_pvaSIAxXr2TgGHeoJLwsQM3oECBkQAA"
                alt="Google Logo">
            <span>Login with Google</span>
        </div>

        <div id="user-info"></div>
    </div>

    <script type="module">
        // Firebase authentication setup script
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOdKI7-hV3BvPvJEPQRuJot-qx9SSSjE0",
            authDomain: "attendance-df720.firebaseapp.com",
            projectId: "attendance-df720",
            storageBucket: "attendance-df720.firebasestorage.app",
            messagingSenderId: "468265145415",
            appId: "1:468265145415:web:66c44f94216104b0e0cd62",
            measurementId: "G-7T9JGB4FGQ"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const googleLoginBtn = document.getElementById('google-login-btn');
        const userInfo = document.getElementById('user-info');

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    fetch('/set_session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username: user.displayName })
                    })
                        .then(() => {
                            window.location.href = "/";
                        });
                })
                .catch((error) => {
                    console.error('Error during sign-in:', error);
                    userInfo.innerHTML = `Error: ${error.message}`;
                });
        });
    </script>

</body>

</html>


use email/password method instead of username and password hardcode